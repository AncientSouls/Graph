{"version":3,"sources":["../../src/lib/adapters/object.js"],"names":["factoryObjectGraph","ParentClassGraph","ObjectGraph","collection","fields","config","arguments","emitter","index","link","_modifier","f","callback","context","_insertModifier","error","id","push","hasOwnProperty","_idGenerator","emit","_error","data","item","isArray","i","_updateModifierAdd","indexOf","_updateModifierPush","_updateModifierRemove","remove","value","modifier","result","m","key","selector","results","_fetch","r","oldResult","cloneDeep","_updateModifier","undefined","length","oldLength","removed","_query","query","newLength","type","doc","s","includes","options","_options","sort","keys","orders","skip","limit","document","fetch","documents","filter","orderBy","slice","links","d","_generateLink","l","map","event","addListener","newDocument","oldDocument","Graph"],"mappings":"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","file":"object.js","sourcesContent":["import { Graph as AncientGraph } from '../graph.js';\nimport lodash from 'lodash';\nimport { EventEmitter } from 'fbemitter';\n\n/**\n * This method allows you to use ObjectGraph class to its inheritance chain.\n *\n * @param {Class} ParentClassGraph\n * @return {Class} ObjectGraph\n */\nfunction factoryObjectGraph(ParentClassGraph) {\n  /**\n   * Inherited class. Class with methods for control links in graph.\n   * Adapted for array collection.\n   * \n   * @class\n   * @description `import { ObjectGraph as Graph } from 'ancient-graph';`\n   */\n  class ObjectGraph extends ParentClassGraph {\n    \n    /**\n     * Construct new graph and checks for required adaptation methods.\n     * @param {Array[]} collection\n     * @param {Object.<string, string>} fields - matching of fields in the link with fields in document\n     * @throws {Error} if the adapter methods is not complete\n     */\n    constructor(collection, fields, config) {\n      super(...arguments);\n      this.emitter = new EventEmitter();\n    }\n    \n    /**\n     * Specifies the id field on insert\n     * \n     * @param {number} index\n     * @param {Link} link\n     * @return {number|string} id;\n     */\n    _idGenerator(index, link) {\n      return \"\"+index;\n    };\n    \n    /**\n     * Generate insert modifier.\n     * \n     * @param {number} index\n     * @param {Link} link\n     * @return {number|string} id;\n     */\n    _insertModifier(link) {\n      var _modifier = {};\n      for (var f in link) {\n        if (this.fields[f]) {\n          _modifier[this.fields[f]] = link[f];\n        }\n      }\n      return _modifier;\n    };\n    \n    /**\n     * Should insert new link into graph.\n     * Return a synchronous result. This can be useful in your application. But for writing generic code, it is recommended to only use the callback result.\n     * \n     * @param {Link} link\n     * @param {Graph~insertCallback} [callback]\n     * @param {Object} [context]\n     * @return {number|string} [id]\n     */\n    insert(link, callback, context) {\n      this.callback\n      var _modifier = this._insertModifier(link);\n      var index, error, id;\n      try {\n        index = this.collection.push(_modifier) - 1;\n        if (!this.collection[index].hasOwnProperty(this.fields['id'])) {\n          id = this.collection[index][this.fields['id']] = this._idGenerator(index, this.collection[index]);\n        }\n        this.emitter.emit('insert', this.collection[index]);\n      } catch(_error) {\n        error = _error;\n      }\n      if (callback) {\n        callback(error, id)\n      }\n      return id;\n    }\n    \n    /**\n     * Optional callback. If present, called with an error object as the first argument and, if no error, the unique id of inserted link as the second.\n     *\n     * @callback Graph~insertCallback\n     * @param {Error} [error]\n     * @param {number|string} [id]\n     */\n    \n    /**\n     * Push into link value some item/items.\n     * \n     * @param {Array} data\n     * @param {string|number|string[]|number[]} item\n     */\n    _updateModifierPush(data, item) {\n      data.push(item);\n    }\n    \n    /**\n     * Push into link value some item/items if not already exists.\n     * \n     * @param {Array} data\n     * @param {string|number|string[]|number[]} item\n     */\n    _updateModifierAdd(data, item) {\n      if (lodash.isArray(item)) {\n        for (var i in item) {\n          this._updateModifierAdd(data, item[i]);\n        }\n      } else {\n        var index = lodash.indexOf(data, item);\n        if (index < 0) {\n          this._updateModifierPush(data, item);\n        }\n      }\n    }\n     \n    /**\n     * Remove from link value some item/items.\n     * \n     * @param {Array} data\n     * @param {string|number|string[]|number[]} item\n     */\n    _updateModifierRemove(data, item) {\n      if (lodash.isArray(item)) {\n        for (var i in item) {\n          this._updateModifierRemove(data, item[i]);\n        }\n      } else {\n        lodash.remove(data, function(value) {\n          return value == item;\n        });\n      }\n    }\n  \n    /**\n     * Generate update modifier.\n     * \n     * @param {LinkModifier} modifier \n     * @param {Object} result\n     * @return {number|string} id;\n     */\n    _updateModifier(modifier, result) {\n      for (var m in modifier) {\n        if (this.fields[m]) {\n          if (typeof(modifier[m]) == 'undefined') {\n            delete result[this.fields[m]];\n          } else {\n            if (typeof(modifier[m]) == 'object') {\n              if (lodash.isArray(modifier[m])) {\n                result[this.fields[m]] = modifier[m];\n              } else {\n                if (!lodash.isArray(result[this.fields[m]])) {\n                  result[this.fields[m]] = result[this.fields[m]]?[result[this.fields[m]]]:[];\n                }\n                for (var key in modifier[m]) {\n                  if (key == 'add') {\n                    this._updateModifierAdd(result[this.fields[m]], modifier[m][key]);\n                  }\n                  if (key == 'push') {\n                    this._updateModifierPush(result[this.fields[m]], modifier[m][key]);\n                  }\n                  if (key == 'remove') {\n                    this._updateModifierRemove(result[this.fields[m]], modifier[m][key]);\n                  }\n                }\n              }\n            } else {\n              result[this.fields[m]] = modifier[m];\n            }\n          }\n        }\n      }\n    };\n    \n    /**\n     * Should update to new state of modifier object link by unique id or by link query object.\n     * If the database allows, it is recommended to return a synchronous result. This can be useful in your application. But for writing generic code, it is recommended to only use the callback result.\n     * \n     * @param {string|LinkSelector} selector\n     * @param {LinkModifier} modifier\n     * @param {Graph~updateCallback} [callback]\n     * @param {Object} [context]\n     * @return {number} [count]\n     */\n    update(selector, modifier, callback, context) {\n      var results = this._fetch(selector);\n      for (var r in results) {\n        var oldResult = lodash.cloneDeep(results[r]);\n        this._updateModifier(modifier, results[r]);\n        this.emitter.emit('update', results[r], oldResult);\n      }\n      if (callback) callback(undefined, results.length);\n      return results.length;\n    }\n    \n    /**\n     * Optional callback. If present, called with an error object as the first argument and, if no error, the number of affected documents as the second.\n     *\n     * @callback Graph~updateCallback\n     * @param {Error} [error]\n     * @param {number} [count]\n     */\n    \n    /**\n     * Should remove link by unique id or by link query object.\n     * \n     * @param {string|LinkSelector} selector\n     * @param {Graph~removeCallback} [callback]\n     * @param {Object} [context]\n     */\n    remove(selector, callback, context) {\n      var oldLength = this.collection.length;\n      var removed = [];\n      lodash.remove(this.collection, (result) => {\n        var _query = this.query(selector)(result);\n        if (_query) removed.push(result)\n        return _query;\n      });\n      for (var r in removed) {\n        this.emitter.emit('remove', removed[r]);\n      }\n      var newLength = this.collection.length;\n      if (callback) callback(undefined, oldLength - newLength);\n    }\n    \n    /**\n     * Optional callback. If present, called with an error object as the first argument.\n     *\n     * @callback Graph~removeCallback\n     * @param {Error} [error]\n     * @param {number} [count]\n     */\n    \n    /**\n     * Generate adapter for database query for links search by unique id or by link query object.\n     * \n     * @param {string|LinkSelector} selector\n     * @return {*} query\n     */\n    query(selector) {\n      var type = typeof(selector);\n      if (type == 'string' || type == 'number') {\n        return (doc) => { return doc[this.fields['id']] == selector };\n      } else if (type == 'object') {\n        return (doc) => {\n          if (typeof(doc) != 'object') return false;\n          for (var m in selector) {\n            if (this.fields[m]) {\n              if (typeof(selector[m]) == 'undefined') {\n                if (doc.hasOwnProperty(this.fields[m])) return false;\n              } else {\n                if (lodash.isArray(doc[this.fields[m]])) {\n                  if (lodash.isArray(selector[m])) {\n                    for (var s in selector[m]) {\n                      if (!lodash.includes(doc[this.fields[m]], selector[m][s])) {\n                        return false;\n                      }\n                    }\n                  } else {\n                    if (!lodash.includes(doc[this.fields[m]], selector[m])) {\n                      return false;\n                    }\n                  }\n                } else {\n                  if (doc[this.fields[m]] != selector[m]) return false;\n                }\n              }\n            }\n          }\n          return true;\n        }\n      }\n    }\n    \n    /**\n     * Generate adapted for database options object.\n     * \n     * @param {Object} [options]\n     * @return {*} options - a options suitable for the database\n     */\n    options(options) {\n      var _options = {};\n      if (options) {\n        if (options.sort) {\n          _options.sort = { keys: [], orders: [] };\n          for (var s in options.sort) {\n            if (this.fields[s]) {\n              _options.sort.keys.push(this.fields[s]);\n              _options.sort.orders.push(options.sort[s]?'asc':'desc');\n            }\n          }\n        }\n        if (typeof(options.skip) == 'number') {\n          _options.skip = options.skip;\n        }\n        if (typeof(options.limit) == 'number') {\n          _options.limit = options.limit;\n        }\n      }\n      return _options;\n    }\n    \n    /**\n     * Generate Link from document by fields.\n     * \n     * @param {Object} document\n     * @return {Link} link\n     */\n    _generateLink(document) {\n      var link = {};\n      for (var f in this.fields) {\n        if (document.hasOwnProperty(this.fields[f])) {\n          link[f] = document[this.fields[f]];\n        }\n      }\n      return link;\n    }\n    \n    /**\n     * Get one first matching link.\n     * \n     * @param {string|LinkSelector} selector\n     * @param {SelectOptions} [options]\n     * @param {Graph~getCallback} [callback]\n     * @return {Link} link - result link object\n     */\n    get(selector, options, callback) {\n      var results = this.fetch(selector, options, (error, results) => {\n        if (callback) callback(error, results?results[0]:undefined);\n      });\n      if (results) return results[0];\n    }\n    \n    /**\n     * Fetch native database documents.\n     * \n     * @param {string|linkSelector} selector\n     * @param {SelectOptions} [options]\n     * @return {Object[]} documents - result documents\n     */\n    _fetch(selector, options) {\n      var query = this.query(selector);\n      var documents = lodash.filter(this.collection, query); \n      var _options = this.options(options);\n      if (_options.sort) documents = lodash.orderBy(documents, _options.sort.keys, _options.orders);\n      var skip = _options.skip?_options.skip:0;\n      var limit = _options.limit?skip+_options.limit:_options.limit;\n      documents = documents.slice(skip, limit);\n      return documents;\n    }\n    \n    /**\n     * Find and all matching links as an Array.\n     * \n     * @param {string|LinkSelector} selector\n     * @param {SelectOptions} [options]\n     * @param {Graph~fetchCallback} [callback]\n     * @return {Link[]} links - result links objects in array\n     */\n    fetch(selector, options, callback) {\n      var documents = this._fetch(selector, options);\n      var links = [];\n      for (var d in documents) {\n        links.push(this._generateLink(documents[d]));\n      }\n      if (callback) callback(undefined, links);\n      return links;\n    }\n    \n    /**\n     * Optional callback. If present, called with an error object as the first argument and, if no error, the result links objects in array.\n     *\n     * @callback Graph~fetchCallback\n     * @param {Error} [error]\n     * @param {Link[]} [links]\n     */\n    \n    /**\n     * Should call callback once for each matching document, sequentially and synchronously.\n     * \n     * @param {string|LinkSelector} selector\n     * @param {SelectOptions} [options]\n     * @param {Graph~eachCallback} [callback]\n     */\n    each(selector, options, callback) {\n      var links = this.fetch(selector, options);\n      for (var l in links) {\n        callback(links[l]);\n      }\n    }\n    \n    /**\n     * @callback Graph~eachCallback\n     * @param {Link} [link]\n     */\n    \n    /**\n     * Map callback over all matching documents. Returns an Array.\n     * \n     * @param {string|LinkSelector} selector\n     * @param {SelectOptions} [options]\n     * @param {Graph~mapCallback} [callback]\n     * @return {Array} results\n     */\n    map(selector, options, callback) {\n      var links = this.fetch(selector, options);\n      return links.map(callback);\n    }\n    \n    /**\n     * @callback Graph~mapCallback\n     * @param {Link} [link]\n     * @return {*} result\n     */\n    \n    /**\n     * Count all matching documents.\n     * \n     * @param {string|LinkSelector} selector\n     * @param {SelectOptions} [options]\n     * @param {Graph~countCallback} [callback]\n     * @return {number} count\n     */\n    count(selector, options, callback) {\n      var links = this.fetch(selector, options);\n      if (callback) callback(undefined, links.length);\n      return links.length;\n    }\n    \n    /**\n     * @callback Graph~countCallback\n     * @param {Error} [error]\n     * @param {number} [count]\n     */\n    \n    /**\n     * Should subscribe to the events: link, unlink, insert, update, remove.\n     * \n     * @param {string} event - name\n     * @param {Graph~onCallback} callback\n     */\n    on(event, callback) {\n      if (event == 'insert') {\n        this.emitter.addListener('insert', (document) => {\n          callback(undefined, this._generateLink(document));\n        });\n      }\n      if (event == 'update') {\n        this.emitter.addListener('update', (newDocument, oldDocument) => {\n          callback(this._generateLink(oldDocument), this._generateLink(newDocument));\n        });\n      }\n      if (event == 'remove') {\n        this.emitter.addListener('remove', (document) => {\n          callback(this._generateLink(document), undefined);\n        });\n      }\n      if (event == 'link') {\n        this.emitter.addListener('insert', (document) => {\n          callback(undefined, this._generateLink(document));\n        });\n        this.emitter.addListener('update', (newDocument, oldDocument) => {\n          callback(this._generateLink(oldDocument), this._generateLink(newDocument));\n        });\n      }\n      if (event == 'unlink') {\n        this.emitter.addListener('update', (newDocument, oldDocument) => {\n          callback(this._generateLink(oldDocument), this._generateLink(newDocument));\n        });\n        this.emitter.addListener('remove', (document) => {\n          callback(this._generateLink(document), undefined);\n        });\n      }\n    }\n    \n    /**\n     * @callback Graph~onCallback\n     * @param {Link} [oldLink] - can be undefined on link and insert events\n     * @param {Link} [newLink] - can be undefined on unlink and remove events\n     * @param {Object} [context] - additional app information, such as context.userId\n     */\n  }\n  \n  return ObjectGraph;\n};\n\nvar ObjectGraph = factoryObjectGraph(AncientGraph);\n\nexport { factoryObjectGraph, ObjectGraph as Graph };"]}