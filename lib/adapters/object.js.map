{"version":3,"sources":["../../src/lib/adapters/object.js"],"names":["factoryObjectGraph","ParentClassGraph","ObjectGraph","collection","fields","config","arguments","emitter","index","link","_modifier","f","aliases","callback","context","_insertModifier","error","id","push","hasOwnProperty","_idGenerator","emit","_error","data","item","isArray","i","_updateModifierAdd","indexOf","_updateModifierPush","_updateModifierRemove","remove","value","modifier","result","m","key","selector","results","_fetch","r","oldResult","cloneDeep","_updateModifier","undefined","length","oldLength","removed","_query","query","newLength","type","doc","s","includes","options","_options","sort","keys","orders","skip","limit","document","fetch","documents","filter","orderBy","slice","links","d","_generateLink","l","map","event","addListener","newDocument","oldDocument","Graph"],"mappings":"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","file":"object.js","sourcesContent":["import { Graph as AncientGraph } from '../graph.js';\r\nimport lodash from 'lodash';\r\nimport { EventEmitter } from 'fbemitter';\r\n\r\n/**\r\n * This method allows you to use ObjectGraph class to its inheritance chain.\r\n *\r\n * @param {Class} ParentClassGraph\r\n * @return {Class} ObjectGraph\r\n */\r\nfunction factoryObjectGraph(ParentClassGraph) {\r\n  /**\r\n   * Inherited class. Class with methods for control links in graph.\r\n   * Adapted for array collection.\r\n   * \r\n   * @class\r\n   * @description `import { ObjectGraph as Graph } from 'ancient-graph';`\r\n   */\r\n  class ObjectGraph extends ParentClassGraph {\r\n    \r\n    /**\r\n     * Construct new graph and checks for required adaptation methods.\r\n     * @param {Array[]} collection\r\n     * @param {Object.<string, string>} fields - matching of fields in the link with fields in document\r\n     * @param {Object} [config] - Additional config.\r\n     * @param {Object} [config.aliases]\r\n     * @param {String} [config.aliases.$]\r\n     * @throws {Error} if the adapter methods is not complete\r\n     */\r\n    constructor(collection, fields, config) {\r\n      super(...arguments);\r\n      this.emitter = new EventEmitter();\r\n    }\r\n    \r\n    /**\r\n     * Specifies the id field on insert\r\n     * \r\n     * @param {number} index\r\n     * @param {Link} link\r\n     * @return {number|string} id;\r\n     */\r\n    _idGenerator(index, link) {\r\n      return \"\"+index;\r\n    };\r\n    \r\n    /**\r\n     * Generate insert modifier.\r\n     * \r\n     * @param {number} index\r\n     * @param {Link} link\r\n     * @return {number|string} id;\r\n     */\r\n    _insertModifier(link) {\r\n      var _modifier = {};\r\n      for (var f in link) {\r\n        if (this.fields[f]) {\r\n          _modifier[this.fields[f]] = link[this.config.aliases[f]];\r\n        }\r\n      }\r\n      return _modifier;\r\n    };\r\n    \r\n    /**\r\n     * Should insert new link into graph.\r\n     * Return a synchronous result. This can be useful in your application. But for writing generic code, it is recommended to only use the callback result.\r\n     * \r\n     * @param {Link} link\r\n     * @param {Graph~insertCallback} [callback]\r\n     * @param {Object} [context]\r\n     * @return {number|string} [id]\r\n     */\r\n    insert(link, callback, context) {\r\n      this.callback\r\n      var _modifier = this._insertModifier(link);\r\n      var index, error, id;\r\n      try {\r\n        index = this.collection.push(_modifier) - 1;\r\n        if (!this.collection[index].hasOwnProperty(this.fields[this.config.aliases['id']])) {\r\n          id = this.collection[index][this.fields[this.config.aliases['id']]] = this._idGenerator(index, this.collection[index]);\r\n        }\r\n        this.emitter.emit('insert', this.collection[index]);\r\n      } catch(_error) {\r\n        error = _error;\r\n      }\r\n      if (callback) {\r\n        callback(error, id)\r\n      }\r\n      return id;\r\n    }\r\n    \r\n    /**\r\n     * Optional callback. If present, called with an error object as the first argument and, if no error, the unique id of inserted link as the second.\r\n     *\r\n     * @callback Graph~insertCallback\r\n     * @param {Error} [error]\r\n     * @param {number|string} [id]\r\n     */\r\n    \r\n    /**\r\n     * Push into link value some item/items.\r\n     * \r\n     * @param {Array} data\r\n     * @param {string|number|string[]|number[]} item\r\n     */\r\n    _updateModifierPush(data, item) {\r\n      data.push(item);\r\n    }\r\n    \r\n    /**\r\n     * Push into link value some item/items if not already exists.\r\n     * \r\n     * @param {Array} data\r\n     * @param {string|number|string[]|number[]} item\r\n     */\r\n    _updateModifierAdd(data, item) {\r\n      if (lodash.isArray(item)) {\r\n        for (var i in item) {\r\n          this._updateModifierAdd(data, item[i]);\r\n        }\r\n      } else {\r\n        var index = lodash.indexOf(data, item);\r\n        if (index < 0) {\r\n          this._updateModifierPush(data, item);\r\n        }\r\n      }\r\n    }\r\n     \r\n    /**\r\n     * Remove from link value some item/items.\r\n     * \r\n     * @param {Array} data\r\n     * @param {string|number|string[]|number[]} item\r\n     */\r\n    _updateModifierRemove(data, item) {\r\n      if (lodash.isArray(item)) {\r\n        for (var i in item) {\r\n          this._updateModifierRemove(data, item[i]);\r\n        }\r\n      } else {\r\n        lodash.remove(data, function(value) {\r\n          return value == item;\r\n        });\r\n      }\r\n    }\r\n  \r\n    /**\r\n     * Generate update modifier.\r\n     * \r\n     * @param {LinkModifier} modifier \r\n     * @param {Object} result\r\n     * @return {number|string} id;\r\n     */\r\n    _updateModifier(modifier, result) {\r\n      for (var m in modifier) {\r\n        if (this.fields[m]) {\r\n          if (typeof(modifier[m]) == 'undefined') {\r\n            delete result[this.fields[m]];\r\n          } else {\r\n            if (typeof(modifier[m]) == 'object') {\r\n              if (lodash.isArray(modifier[m])) {\r\n                result[this.fields[m]] = modifier[m];\r\n              } else {\r\n                if (!lodash.isArray(result[this.fields[m]])) {\r\n                  result[this.fields[m]] = result[this.fields[m]]?[result[this.fields[m]]]:[];\r\n                }\r\n                for (var key in modifier[m]) {\r\n                  if (key == 'add') {\r\n                    this._updateModifierAdd(result[this.fields[m]], modifier[m][key]);\r\n                  }\r\n                  if (key == 'push') {\r\n                    this._updateModifierPush(result[this.fields[m]], modifier[m][key]);\r\n                  }\r\n                  if (key == 'remove') {\r\n                    this._updateModifierRemove(result[this.fields[m]], modifier[m][key]);\r\n                  }\r\n                }\r\n              }\r\n            } else {\r\n              result[this.fields[m]] = modifier[m];\r\n            }\r\n          }\r\n        }\r\n      }\r\n    };\r\n    \r\n    /**\r\n     * Should update to new state of modifier object link by unique id or by link query object.\r\n     * If the database allows, it is recommended to return a synchronous result. This can be useful in your application. But for writing generic code, it is recommended to only use the callback result.\r\n     * \r\n     * @param {string|LinkSelector} selector\r\n     * @param {LinkModifier} modifier\r\n     * @param {Graph~updateCallback} [callback]\r\n     * @param {Object} [context]\r\n     * @return {number} [count]\r\n     */\r\n    update(selector, modifier, callback, context) {\r\n      var results = this._fetch(selector);\r\n      for (var r in results) {\r\n        var oldResult = lodash.cloneDeep(results[r]);\r\n        this._updateModifier(modifier, results[r]);\r\n        this.emitter.emit('update', results[r], oldResult);\r\n      }\r\n      if (callback) callback(undefined, results.length);\r\n      return results.length;\r\n    }\r\n    \r\n    /**\r\n     * Optional callback. If present, called with an error object as the first argument and, if no error, the number of affected documents as the second.\r\n     *\r\n     * @callback Graph~updateCallback\r\n     * @param {Error} [error]\r\n     * @param {number} [count]\r\n     */\r\n    \r\n    /**\r\n     * Should remove link by unique id or by link query object.\r\n     * \r\n     * @param {string|LinkSelector} selector\r\n     * @param {Graph~removeCallback} [callback]\r\n     * @param {Object} [context]\r\n     */\r\n    remove(selector, callback, context) {\r\n      var oldLength = this.collection.length;\r\n      var removed = [];\r\n      lodash.remove(this.collection, (result) => {\r\n        var _query = this.query(selector)(result);\r\n        if (_query) removed.push(result)\r\n        return _query;\r\n      });\r\n      for (var r in removed) {\r\n        this.emitter.emit('remove', removed[r]);\r\n      }\r\n      var newLength = this.collection.length;\r\n      if (callback) callback(undefined, oldLength - newLength);\r\n    }\r\n    \r\n    /**\r\n     * Optional callback. If present, called with an error object as the first argument.\r\n     *\r\n     * @callback Graph~removeCallback\r\n     * @param {Error} [error]\r\n     * @param {number} [count]\r\n     */\r\n    \r\n    /**\r\n     * Generate adapter for database query for links search by unique id or by link query object.\r\n     * \r\n     * @param {string|LinkSelector} selector\r\n     * @return {*} query\r\n     */\r\n    query(selector) {\r\n      var type = typeof(selector);\r\n      if (type == 'string' || type == 'number') {\r\n        return (doc) => { return doc[this.fields[this.config.aliases['id']]] == selector };\r\n      } else if (type == 'object') {\r\n        return (doc) => {\r\n          if (typeof(doc) != 'object') return false;\r\n          for (var m in selector) {\r\n            if (this.fields[m]) {\r\n              if (typeof(selector[m]) == 'undefined') {\r\n                if (doc.hasOwnProperty(this.fields[m])) return false;\r\n              } else {\r\n                if (lodash.isArray(doc[this.fields[m]])) {\r\n                  if (lodash.isArray(selector[m])) {\r\n                    for (var s in selector[m]) {\r\n                      if (!lodash.includes(doc[this.fields[m]], selector[m][s])) {\r\n                        return false;\r\n                      }\r\n                    }\r\n                  } else {\r\n                    if (!lodash.includes(doc[this.fields[m]], selector[m])) {\r\n                      return false;\r\n                    }\r\n                  }\r\n                } else {\r\n                  if (doc[this.fields[m]] != selector[m]) return false;\r\n                }\r\n              }\r\n            }\r\n          }\r\n          return true;\r\n        }\r\n      }\r\n    }\r\n    \r\n    /**\r\n     * Generate adapted for database options object.\r\n     * \r\n     * @param {Object} [options]\r\n     * @return {*} options - a options suitable for the database\r\n     */\r\n    options(options) {\r\n      var _options = {};\r\n      if (options) {\r\n        if (options.sort) {\r\n          _options.sort = { keys: [], orders: [] };\r\n          for (var s in options.sort) {\r\n            if (this.fields[s]) {\r\n              _options.sort.keys.push(this.fields[s]);\r\n              _options.sort.orders.push(options.sort[s]?'asc':'desc');\r\n            }\r\n          }\r\n        }\r\n        if (typeof(options.skip) == 'number') {\r\n          _options.skip = options.skip;\r\n        }\r\n        if (typeof(options.limit) == 'number') {\r\n          _options.limit = options.limit;\r\n        }\r\n      }\r\n      return _options;\r\n    }\r\n    \r\n    /**\r\n     * Generate Link from document by fields.\r\n     * \r\n     * @param {Object} document\r\n     * @return {Link} link\r\n     */\r\n    _generateLink(document) {\r\n      var link = {};\r\n      for (var f in this.fields) {\r\n        if (document.hasOwnProperty(this.fields[f])) {\r\n          link[f] = document[this.fields[f]];\r\n        }\r\n      }\r\n      return link;\r\n    }\r\n    \r\n    /**\r\n     * Get one first matching link.\r\n     * \r\n     * @param {string|LinkSelector} selector\r\n     * @param {SelectOptions} [options]\r\n     * @param {Graph~getCallback} [callback]\r\n     * @return {Link} link - result link object\r\n     */\r\n    get(selector, options, callback) {\r\n      var results = this.fetch(selector, options, (error, results) => {\r\n        if (callback) callback(error, results?results[0]:undefined);\r\n      });\r\n      if (results) return results[0];\r\n    }\r\n    \r\n    /**\r\n     * Fetch native database documents.\r\n     * \r\n     * @param {string|linkSelector} selector\r\n     * @param {SelectOptions} [options]\r\n     * @return {Object[]} documents - result documents\r\n     */\r\n    _fetch(selector, options) {\r\n      var query = this.query(selector);\r\n      var documents = lodash.filter(this.collection, query); \r\n      var _options = this.options(options);\r\n      if (_options.sort) documents = lodash.orderBy(documents, _options.sort.keys, _options.orders);\r\n      var skip = _options.skip?_options.skip:0;\r\n      var limit = _options.limit?skip+_options.limit:_options.limit;\r\n      documents = documents.slice(skip, limit);\r\n      return documents;\r\n    }\r\n    \r\n    /**\r\n     * Find and all matching links as an Array.\r\n     * \r\n     * @param {string|LinkSelector} selector\r\n     * @param {SelectOptions} [options]\r\n     * @param {Graph~fetchCallback} [callback]\r\n     * @return {Link[]} links - result links objects in array\r\n     */\r\n    fetch(selector, options, callback) {\r\n      var documents = this._fetch(selector, options);\r\n      var links = [];\r\n      for (var d in documents) {\r\n        links.push(this._generateLink(documents[d]));\r\n      }\r\n      if (callback) callback(undefined, links);\r\n      return links;\r\n    }\r\n    \r\n    /**\r\n     * Optional callback. If present, called with an error object as the first argument and, if no error, the result links objects in array.\r\n     *\r\n     * @callback Graph~fetchCallback\r\n     * @param {Error} [error]\r\n     * @param {Link[]} [links]\r\n     */\r\n    \r\n    /**\r\n     * Should call callback once for each matching document, sequentially and synchronously.\r\n     * \r\n     * @param {string|LinkSelector} selector\r\n     * @param {SelectOptions} [options]\r\n     * @param {Graph~eachCallback} [callback]\r\n     */\r\n    each(selector, options, callback) {\r\n      var links = this.fetch(selector, options);\r\n      for (var l in links) {\r\n        callback(links[l]);\r\n      }\r\n    }\r\n    \r\n    /**\r\n     * @callback Graph~eachCallback\r\n     * @param {Link} [link]\r\n     */\r\n    \r\n    /**\r\n     * Map callback over all matching documents. Returns an Array.\r\n     * \r\n     * @param {string|LinkSelector} selector\r\n     * @param {SelectOptions} [options]\r\n     * @param {Graph~mapCallback} [callback]\r\n     * @return {Array} results\r\n     */\r\n    map(selector, options, callback) {\r\n      var links = this.fetch(selector, options);\r\n      return links.map(callback);\r\n    }\r\n    \r\n    /**\r\n     * @callback Graph~mapCallback\r\n     * @param {Link} [link]\r\n     * @return {*} result\r\n     */\r\n    \r\n    /**\r\n     * Count all matching documents.\r\n     * \r\n     * @param {string|LinkSelector} selector\r\n     * @param {SelectOptions} [options]\r\n     * @param {Graph~countCallback} [callback]\r\n     * @return {number} [count]\r\n     */\r\n    count(selector, options, callback) {\r\n      var links = this.fetch(selector, options);\r\n      if (callback) callback(undefined, links.length);\r\n      return links.length;\r\n    }\r\n    \r\n    /**\r\n     * @callback Graph~countCallback\r\n     * @param {Error} [error]\r\n     * @param {number} [count]\r\n     */\r\n    \r\n    /**\r\n     * Should subscribe to the events: link, unlink, insert, update, remove.\r\n     * \r\n     * @param {string} event - name\r\n     * @param {Graph~onCallback} callback\r\n     */\r\n    on(event, callback) {\r\n      if (event == 'insert') {\r\n        this.emitter.addListener('insert', (document) => {\r\n          callback(undefined, this._generateLink(document));\r\n        });\r\n      }\r\n      if (event == 'update') {\r\n        this.emitter.addListener('update', (newDocument, oldDocument) => {\r\n          callback(this._generateLink(oldDocument), this._generateLink(newDocument));\r\n        });\r\n      }\r\n      if (event == 'remove') {\r\n        this.emitter.addListener('remove', (document) => {\r\n          callback(this._generateLink(document), undefined);\r\n        });\r\n      }\r\n      if (event == 'link') {\r\n        this.emitter.addListener('insert', (document) => {\r\n          callback(undefined, this._generateLink(document));\r\n        });\r\n        this.emitter.addListener('update', (newDocument, oldDocument) => {\r\n          callback(this._generateLink(oldDocument), this._generateLink(newDocument));\r\n        });\r\n      }\r\n      if (event == 'unlink') {\r\n        this.emitter.addListener('update', (newDocument, oldDocument) => {\r\n          callback(this._generateLink(oldDocument), this._generateLink(newDocument));\r\n        });\r\n        this.emitter.addListener('remove', (document) => {\r\n          callback(this._generateLink(document), undefined);\r\n        });\r\n      }\r\n    }\r\n    \r\n    /**\r\n     * @callback Graph~onCallback\r\n     * @param {Link} [oldLink] - can be undefined on link and insert events\r\n     * @param {Link} [newLink] - can be undefined on unlink and remove events\r\n     * @param {Object} [context] - additional app information, such as context.userId\r\n     */\r\n  }\r\n  \r\n  return ObjectGraph;\r\n};\r\n\r\nvar ObjectGraph = factoryObjectGraph(AncientGraph);\r\n\r\nexport { factoryObjectGraph, ObjectGraph as Graph };"]}